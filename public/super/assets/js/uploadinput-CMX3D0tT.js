import{m as Q}from"./@vueuse-BIgT8fdk.js";import{S as Y,_ as M,l as P,k as Z,q as _,i as x}from"./index-BfYElSN2.js";import{a as z,E as ee}from"./element-plus-C9Ov05af.js";import{d as N,m as R,h as $,$ as j,ag as y,o as g,c as F,X as d,T as p,W as I,S as A,n as V,aq as ae,a9 as te,a as S,v as T,q as U,F as q,p as K,a8 as W,U as le,t as ne,a3 as oe,i as se,u as w,x as ie,L as re}from"./@vue-CRBWlwId.js";const de=N({name:"DiyUpload",props:{uploadTip:{type:String,required:!1,default:"请选择资源进行(支持拖拽)上传，"},multiple:{type:Boolean,required:!1,default:!0},showFileList:{type:Boolean,required:!1,default:!0},drag:{type:Boolean,required:!1,default:!1},accept:{type:String,required:!1,default:"*/*"},type:{type:String,required:!1,default:"image"},limit:{type:Number,required:!1,default:0},autoUpload:{type:Boolean,required:!1,default:!0},parentId:{type:String,required:!1,default:"0"},local:{type:String,required:!1,default:"0"}},emits:["update:value","upload","confirm"],setup(e,{emit:l}){const a=R({visible:!1,loading:!1,moduleName:"",tokenLoading:!1,uploadUrl:"/sys/storage/upload",params:{timestamp:Math.round(new Date().getTime()/1e3)+100,format:"json",type:e.type,parentId:e.parentId,local:e.local},headers:{Authorization:Y.get("token")}}),f=$(),C=()=>{a.visible=!1,a.loading=!1,f.value&&f.value.clearFiles()},i=()=>{l("confirm"),C()},m=(s,c)=>{if(s.status==="success"&&s.response){const o=s.response.data;o&&o[0].storage_id}l("upload",c)},h=()=>{a.params.timestamp=Math.round(new Date().getTime()/1e3)+100,e.autoUpload&&(a.loading=!0)},k=(s,c,o)=>{if(s.code===200&&s.data){l("upload",o),b(o);return}v(s.msg,c,o)},v=(s,c,o)=>{z.error(s);for(let n=o.length-1;n>=0;n--)if(c===o[n]){o.splice(n,1),l("upload",o);break}b(o)},D=(s,c)=>{if(s.length+c.length>e.limit){const o=e.limit-c.length;z.error(`上传数量超出限制，最多还能选择 ${o} 个文件`)}},b=s=>{if(e.autoUpload){Object.keys(s).every(o=>s[o].status==="success")&&(a.loading=!1);let c=s.filter(o=>o.status==="success");c.length==s.length&&setTimeout(function(){f.value.clearFiles()},500),l("confirm",c)}};return{...j(a),upload:f,handleClose:C,handleConfirm:i,handleBeforeUpload:h,handleRemove:m,handleSuccess:k,handleError:v,handleExceed:D,handleChange:b}}});function ue(e,l,a,f,C,i){const m=y("el-button"),h=y("el-upload");return g(),F("div",{class:"upload-control",onClick:l[0]||(l[0]=k=>e.visible=!0)},[d(h,{ref:"upload","list-type":"text",action:e.uploadUrl,data:e.params,multiple:e.multiple,"show-file-list":e.showFileList,drag:e.drag,accept:e.accept,limit:e.limit,headers:e.headers,"auto-upload":e.autoUpload,"on-remove":e.handleRemove,"before-upload":e.handleBeforeUpload,"on-success":e.handleSuccess,"on-error":e.handleError,"on-exceed":e.handleExceed},{default:p(()=>[d(m,{type:"primary"},{default:p(()=>[I("点击上传")]),_:1})]),_:1},8,["action","data","multiple","show-file-list","drag","accept","limit","headers","auto-upload","on-remove","before-upload","on-success","on-error","on-exceed"])])}const ce=M(de,[["render",ue]]),pe=N({name:"DiyPagefooter",props:{current:{default:0},size:{default:0},total:{default:0},loading:{default:!1},isSize:{default:!0}},emits:["change"],setup(e,{emit:l}){const a=R({sizes:[10,15,25,50,100,250,500],layout:"total, sizes, prev, pager, next",simple:"total, prev, pager, next"});return{handleSizeChange:i=>{l("change",{current:e.current,size:i,total:e.total})},handleCurrentChange:i=>{l("change",{current:i,size:e.size,total:e.total})},...j(a)}}});function me(e,l,a,f,C,i){const m=y("el-pagination");return g(),A(m,{small:"","page-size":e.size,total:e.total,"page-sizes":e.sizes,disabled:e.loading,layout:e.sizes.includes(e.size)&&e.isSize?e.layout:e.simple,onSizeChange:e.handleSizeChange,onCurrentChange:e.handleCurrentChange},null,8,["page-size","total","page-sizes","disabled","layout","onSizeChange","onCurrentChange"])}const fe=M(pe,[["render",me],["__scopeId","data-v-0ac2ae8b"]]),ge=N({name:"DiyStorage",components:{DiyUpload:ce,DiyPagefooter:fe},props:{type:{default:"image"},accept:{default:"image/*"},limit:{type:Number,required:!1,default:0},isSelect:{default:"1"},local:{type:String,default:"0"}},setup(e,{emit:l}){const a=R({baseUrl:"",title:"",isLoad:!1,icontype:"default",visible:!1,loading:!1,uploadConfig:{uploadTip:"请选择文件进行上传，",multiple:!0,accept:"image/*",limit:0,type:"image",replace:!1},storageType:e.type,source:"",loadingCollection:!1,checkList:[],categorys:[],syscategorys:[],currentTableData:[],currentSysTableData:[],searchSysTableData:[],dialogLoading:!1,nameForm:{type:"",name:void 0,parentId:void 0},nameFormVisible:!1,nameStatus:"edit",nameMap:{edit:"重命名",add:"新增目录"},iconfonturl:"",rules:{name:[{required:!0,message:"目录名称不能为空",trigger:"blur"},{max:255,message:"长度不能大于 255 个字符",trigger:"blur"}]},form:{name:void 0,parentId:void 0,order_type:"desc",order_field:"storageId"},sysform:{parentId:"icon1",name:"",type:"system"},page:{current:1,size:15,total:0}}),f=$(null),C=t=>t.type=="mp3"||t.type=="mp4"?"/static/images/mp3.png":t.type=="image"||t.type=="scene"?t.url:"/static/images/file.png",i=(t="",u="")=>{a.title=u||"文件管理",a.visible=!0,a.storageType=e.type,a.source=t,a.checkList=[],a.currentTableData.forEach(r=>{r.selectclz=""}),a.isLoad||(a.loadingCollection=!1,a.currentTableData=[],a.uploadConfig.type=e.type,k(),V(()=>{var r;H(),f.value&&((r=f.value)==null||r.handleClose())}))},m=t=>{a.page=t,V(()=>{k()})},h=()=>{a.page.current=1,k()},k=()=>{a.loading=!0,P("/sys/storage",{...a.form,type:a.storageType,pageNum:a.page.current,pageSize:a.page.size}).then(t=>{a.currentTableData=t.rows||[],a.page.total=t.total,a.isLoad=!0}).finally(()=>{a.loading=!1})},v=()=>{a.loading=!0,P("/sys/storage",{...a.sysform}).then(t=>{a.currentSysTableData=t.rows||[],a.searchSysTableData=t.rows||[]}).finally(()=>{a.loading=!1})},D=()=>{a.loading=!0,P("/sys/storage",{...a.sysform}).then(t=>{a.syscategorys=t.rows||[],a.sysform.type="system",a.sysform.parentId=t.rows[0].storageId,v()}).finally(()=>{a.loading=!1})},b=()=>{let t=a.currentSysTableData.filter(u=>u.name.indexOf(a.sysform.name)>=0||u.cname.indexOf(a.sysform.name)>=0);a.searchSysTableData=t},s=()=>{if(a.loading){z.error("点击过快，正在加载数据");return}a.sysform.parentId="",v()},c=()=>{if(a.checkList.length<=0){l("confirm",[],a.source),a.visible=!1;return}let t=a.checkList;a.loadingCollection=!1,a.visible=!1,l("confirm",t||[],a.source)},o=t=>{if(a.loading){z.error("点击过快，正在加载数据");return}a.form.parentId=t,k()},n=t=>{if(a.loading){z.error("点击过快，正在加载数据");return}a.sysform.name="",a.iconfonturl=t.url,a.sysform.parentId=t.storageId,v()},E=t=>{if(e.limit===1){a.currentSysTableData.forEach(r=>{r.selectclz=""}),a.currentTableData.forEach(r=>{r.selectclz=""});let u=a.checkList.findIndex(r=>r==t.storageId);u>=0?(a.checkList.splice(u,1),t.selectclz=""):a.checkList.length>0?(a.checkList.splice(0,1,t),t.selectclz="active"):(a.checkList.push(t),t.selectclz="active")}else{let u=a.checkList.findIndex(r=>r.storageId==t.storageId);u>=0?(a.checkList.splice(u,1),t.selectclz=""):(a.checkList.push(t),t.selectclz="active")}},L=t=>{const u=t?[t]:a.checkList;if(u.length===0){z.error("请选择要操作的数据");return}ee.confirm("确定要执行该操作吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",closeOnClickModal:!1}).then(()=>{Z("/sys/storage",u).then(()=>{for(let r=a.currentTableData.length-1;r>=0;r--)u.indexOf(a.currentTableData[r].storageId)!==-1&&a.currentTableData.splice(r,1);z.success("操作成功")})}).catch(()=>{})},X=t=>{for(const u of t){let r=u.response.data,O=a.currentTableData.findIndex(J=>J.url==r.url);O!=0&&(O>0&&a.currentTableData.splice(O,1),a.currentTableData.splice(0,0,r))}},B=$(),G=$(),H=()=>{_("/sys/storage",{type:"category"}).then(t=>{a.categorys=t.rows})};return{refform:B,refinput:G,selectSystemCategory:n,rename:()=>{B.value.validate(t=>{t&&(a.dialogLoading=!0)})},add:()=>{B.value.validate(t=>{t&&(a.dialogLoading=!0,a.nameForm.type="category",x("/sys/storage",{...a.nameForm}).then(u=>{a.categorys.unshift({...u.data,is_default:0}),a.nameFormVisible=!1,z.success("操作成功")}).catch(()=>{a.dialogLoading=!1}))})},handleAdd:()=>{a.nameForm.name=void 0,a.nameForm.parentId=a.form.parentId,a.dialogLoading=!1,a.nameStatus="add",a.nameFormVisible=!0,V(()=>{B.value.clearValidate()})},handleClick:()=>{a.syscategorys.length==0&&a.icontype=="system"&&(a.sysform.type="systemcategorys",D())},...j(a),_getUploadFileList:X,selectCategory:o,getImageThumb:C,selectFile:E,handleDelete:L,handleSearch:h,handleAllSearch:s,handleConfirm:c,handlePaginationChange:m,handleStorageDlg:i,handleSysSearch:b}}}),ye={class:"flex storages"},he={class:"categorys diy-tree file-border flex flex-direction-column"},ve=["onClick"],be={class:"flex1 file-border"},Ce={class:"flex justify-between"},ke={class:"diy-mb-20"},Se=["max"],De={class:"file-list"},Fe=["data-label"],ze=["onClick"],Ie={class:"file-name"},Te=["onClick"],$e=["onClick"],we={style:{float:"left","font-size":"13px"}},Ve={key:0,style:{color:"#f56c6c"}},Ee={key:1};function Le(e,l,a,f,C,i){const m=y("el-button"),h=y("SvgIcon"),k=y("el-input"),v=y("diy-upload"),D=y("diy-pagefooter"),b=y("el-dialog"),s=y("el-form-item"),c=y("el-form"),o=ae("loading");return g(),F(q,null,[d(b,{title:e.title,top:"5vh",modelValue:e.visible,"onUpdate:modelValue":l[6]||(l[6]=n=>e.visible=n),"append-to-body":"",center:"",width:"800px"},te({default:p(()=>[S("div",ye,[S("div",he,[d(m,{type:"primary",onClick:l[0]||(l[0]=n=>e.handleAdd())},{default:p(()=>[I("新增目录")]),_:1}),S("div",{class:U(["mt-1 text-center",[e.form.parentId?"":"selected"]]),plain:"",onClick:l[1]||(l[1]=n=>e.selectCategory(""))},"全部",2),(g(!0),F(q,null,K(e.categorys,n=>(g(),F("div",{class:U(["mt-1 p-1 text-center",[e.form.parentId==n.storageId?"selected":""]]),plain:"",key:n,onClick:E=>e.selectCategory(n.storageId)},T(n.name),11,ve))),128))]),S("div",be,[S("div",Ce,[S("div",ke,[d(k,{modelValue:e.form.name,"onUpdate:modelValue":l[2]||(l[2]=n=>e.form.name=n),"label-width":"0px",placeholder:"输入名称搜索",style:{width:"250px"},onKeyup:l[3]||(l[3]=W(n=>e.handleSearch(),["enter","native"])),onClear:l[4]||(l[4]=n=>e.handleSearch()),clearable:!0},{suffix:p(()=>[d(h,{onClick:e.handleSearch,name:"ele-Search",size:20},null,8,["onClick"])]),_:1},8,["modelValue"])]),d(v,{ref:"upload","upload-tip":e.uploadConfig.uploadTip,multiple:e.uploadConfig.multiple,type:e.type,local:e.local,accept:e.accept,limit:e.uploadConfig.limit,"parent-id":e.form.parentId,onConfirm:e._getUploadFileList},null,8,["upload-tip","multiple","type","local","accept","limit","parent-id","onConfirm"])]),S("div",{class:"files",max:e.limit!==0?e.limit:100},[le((g(),F("div",De,[(g(!0),F(q,null,K(e.currentTableData,(n,E)=>(g(),F("div",{key:E,class:U(["item",n.selectclz]),"data-label":n.name},[S("div",{class:"file-image",style:ne({backgroundImage:"url("+e.getImageThumb(n)+")"}),onClick:L=>e.selectFile(n)},null,12,ze),S("div",Ie,T(n.name),1),S("div",{class:"mask",onClick:L=>e.selectFile(n)},[d(h,{name:"ele-Check",size:20})],8,Te),S("div",{class:"el-dropdown",onClick:L=>e.handleDelete(n.storageId)},[d(h,{class:"delete",name:"ele-Delete",size:20})],8,$e)],10,Fe))),128))])),[[o,e.loading]])],8,Se),d(D,{style:{margin:"0",padding:"20px 0 0 0"},current:e.page.current,size:e.page.size,total:e.page.total,"is-size":!1,onChange:e.handlePaginationChange},null,8,["current","size","total","onChange"])])])]),_:2},[e.isSelect=="1"?{name:"footer",fn:p(()=>[S("div",we,[e.checkList.length>e.limit&&e.limit!==0?(g(),F("span",Ve," 当前已选 "+T(e.checkList.length)+" 个，最多允许选择 "+T(e.limit)+" 个文件 ",1)):(g(),F("span",Ee,"当前已选 "+T(e.checkList.length)+" 个文件",1))]),d(m,{onClick:l[5]||(l[5]=n=>e.visible=!1)},{default:p(()=>[I("取消")]),_:1}),d(m,{type:"primary",loading:e.loadingCollection,disabled:e.checkList.length>e.limit&&e.limit!==0,onClick:e.handleConfirm},{default:p(()=>[I("确定")]),_:1},8,["loading","disabled","onClick"])]),key:"0"}:void 0]),1032,["title","modelValue"]),d(b,{title:e.nameMap[e.nameStatus],modelValue:e.nameFormVisible,"onUpdate:modelValue":l[11]||(l[11]=n=>e.nameFormVisible=n),"append-to-body":"",center:"",top:"5vh",width:"600px"},{footer:p(()=>[d(m,{onClick:l[10]||(l[10]=n=>e.nameFormVisible=!1)},{default:p(()=>[I("取消")]),_:1}),e.nameStatus==="add"?(g(),A(m,{key:0,type:"primary",loading:e.dialogLoading,onClick:e.add},{default:p(()=>[I("确定")]),_:1},8,["loading","onClick"])):(g(),A(m,{key:1,type:"primary",loading:e.dialogLoading,onClick:e.rename},{default:p(()=>[I("修改")]),_:1},8,["loading","onClick"]))]),default:p(()=>[d(c,{model:e.nameForm,rules:e.rules,ref:"refform","label-width":"50px","label-position":"left",onSubmit:l[9]||(l[9]=oe(()=>{},["prevent"]))},{default:p(()=>[d(s,{label:"名称",prop:"name"},{default:p(()=>[d(k,{modelValue:e.nameForm.name,"onUpdate:modelValue":l[7]||(l[7]=n=>e.nameForm.name=n),placeholder:"请输入目录名称",onKeyup:l[8]||(l[8]=W(n=>e.nameStatus==="add"?e.add():e.rename(),["enter","native"])),ref:"input"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])],64)}const Be=M(ge,[["render",Le],["__scopeId","data-v-2656c0f5"]]),Ue=N({__name:"uploadinput",props:{modelValue:{type:String,default:""},title:{type:String,default:""},type:{type:String,default:"image"},accept:{type:String,default:"image/*"},local:{type:String,default:"0"}},emits:["update:modelValue","change","blur"],setup(e,{emit:l}){const a=e,f=$(null),C=l,i=Q(a,"modelValue",C),m=()=>{V(()=>{f.value.handleStorageDlg("","上传"+a.title)})};se(i,()=>{C("change"),C("blur")});const h=$(null),k=(v=[])=>{v.length&&(a.local=="1"?i.value=v[0].path:i.value=v[0].url,V(()=>{var D,b;(D=h.value)==null||D.input.focus(),(b=h.value)==null||b.input.blur()}))};return(v,D)=>{const b=y("el-image"),s=y("el-button"),c=y("el-input");return g(),F(q,null,[d(c,{type:"text",ref_key:"formImg",ref:h,class:U(w(i)&&e.type=="image"?"diygw-img-input":""),modelValue:w(i),"onUpdate:modelValue":D[0]||(D[0]=o=>re(i)?i.value=o:null),clearable:"",placeholder:"请选择"+e.title},{append:p(()=>[w(i)&&e.type=="image"?(g(),A(b,{key:0,src:w(i),style:{width:"30px",height:"30px"},"preview-teleported":!0,"preview-src-list":[w(i)]},null,8,["src","preview-src-list"])):ie("",!0),d(s,{onClick:m},{default:p(()=>[I(" 选择"+T(e.title),1)]),_:1})]),_:1},8,["class","modelValue","placeholder"]),d(Be,{ref_key:"storage",ref:f,type:e.type,local:e.local,accept:e.accept,limit:1,onConfirm:k},null,8,["type","local","accept"])],64)}}}),Ke=M(Ue,[["__scopeId","data-v-19cb2811"]]);export{Ke as D,Be as a};
